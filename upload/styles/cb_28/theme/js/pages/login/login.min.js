var inputs=document.querySelectorAll("#mfa_code input"),modalElement=document.getElementById("enterMFACodeModal"),confirmButton=document.getElementById("confirmMFACodeBtn"),closeModalButton=document.querySelector(".close");function closeModal(){modalElement.classList.remove("in"),modalElement.style.display="none",modalElement.setAttribute("aria-hidden","true"),document.body.classList.remove("modal-open");let e=document.querySelector(".modal-backdrop");e&&e.remove()}function showModal(){modalElement.classList.add("in"),modalElement.style.display="block",modalElement.setAttribute("aria-hidden","false"),document.body.classList.add("modal-open");let e=document.createElement("div");e.className="modal-backdrop fade in",document.body.appendChild(e),modalElement.querySelectorAll('[data-dismiss="modal"]').forEach(function(e){e.addEventListener("click",closeModal)})}function insertHTMLAfter(e,t){let n=document.createRange();n.setStartAfter(e);let o=n.createContextualFragment(t);e.parentNode.insertBefore(o,e.nextSibling)}need_mfa=!1,document.addEventListener("DOMContentLoaded",function(){inputs=document.querySelectorAll("#mfa_code input"),modalElement=document.getElementById("enterMFACodeModal"),confirmButton=document.getElementById("confirmMFACodeBtn"),closeModalButton=document.querySelector(".close");let e=document.querySelector('form[name="login_form"]');e.addEventListener("submit",function(e){e.preventDefault(),showSpinner();let t=document.getElementById("login_username_sp").value,n=document.getElementById("login_password_sp").value,o=document.getElementById("remember_me").value;if(""===t||""===n)return alert(lang.please_fill_all_fields),hideSpinner(),!1;let l="";if("undefined"!=typeof need_mfa&&need_mfa){if(!1===modalElement.classList.contains("in"))return showModal(),hideSpinner(),!1;if(inputs.forEach(e=>{l+=e.value}),""===l.trim())return alert(lang.please_enter_mfa_code),hideSpinner(),!1;if(6!==l.length)return alert(lang.please_enter_6_digit_mfa_code),hideSpinner(),!1}fetch(baseurl+"actions/login.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({username:t,password:n,mfa_code:l,remember_me:o})}).then(e=>e.json()).then(e=>{e.need_mfa?(showModal(),need_mfa=!0):e.success&&(window.location.href=e.redirect);let t=document.querySelector("#enterMFACodeModal > div > div > div.modal-body > .form-group");t&&insertHTMLAfter(t,e.msg)}).catch(e=>{console.error("Login error:",e),alert("An error occurred")}).finally(hideSpinner)}),confirmButton&&confirmButton.addEventListener("click",function(){e.requestSubmit()}),closeModalButton.addEventListener("click",function(){closeModal()}),inputs.forEach((e,t)=>{e.addEventListener("input",()=>{1===e.value.length&&t<inputs.length-1&&inputs[t+1].focus()}),e.addEventListener("keydown",n=>{"Backspace"===n.key&&""===e.value&&t>0&&inputs[t-1].focus()}),e.addEventListener("paste",e=>{e.preventDefault();let t=e.clipboardData.getData("text");for(let n=0;n<inputs.length;n++)inputs[n].value=t[n]||"";let o=Math.min(t.length,inputs.length)-1;o>=0&&inputs[o].focus()})})});
