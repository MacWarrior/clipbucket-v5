function showSpinner(){$(".spinner-content").show()}function hideSpinner(){$(".spinner-content").hide()}$(document).ready(function(){var e=[];uploader=new plupload.Uploader({browse_button:"selectFiles",dragdrop:!0,drop_element:"dragDrop",runtimes:"html5,silverlight,html4",url:uploadScriptPath,file_data_name:"Filedata",chunk_size:!!chunk_upload&&max_upload_size,max_file_size:max_file_size,filters:{mime_types:[{title:"Image files",extensions:photo_extensions}]}});var a="";uploader.init(),uploader.bind("FilesAdded",function(t,o){var n,l,s,i,d,r,c,p;for(let u=0;u<o.length;u++)e.push(o[u]),o[u].data=[],o[u].data.photo_title=o[0].name,o[u].data.photo_description=o[0].name,o[u].data.photo_tags="",o[u].data.collection_id=$("#collectionSelection").val(),o[u].data.allow_comments="yes",o[u].data.allow_embedding="yes",o[u].data.allow_rating="yes",o[u].data.photoThumb="",o[u].data.photo_id=0,o[u].data.unique_id=(Math.random()+1).toString(36).substring(7);n=t,(s=document.createElement("ul")).id="selectedFilesList",s.className="nav nav-tabs",i=!1,d=1,r=$("#photoForm form").clone(),c=!1,p=[],plupload.each(n.files,function(e){i=document.createElement("li"),d===n.files.length?i.className="active":i.className="";var a=document.createElement("a");a.href="#tab"+d,a.setAttribute("data-toggle","tab"),n.files.length<8?a.innerHTML="("+d+") "+e.name.substring(0,10):a.innerHTML="("+d+") ",(c=$(r).clone().get(0)).className="updatePhotoInfoForm",c.id="";var t=document.createElement("div");t.id="tab"+d,d===n.files.length?t.className="tab-pane active uploadFormContainer":t.className="tab-pane uploadFormContainer",$(c).find(".cancel_button").attr("to_cancel",d),$(c).find("input[name='photo_title']").val(e.data.photo_title),$(c).find("textarea[name='photo_description']").val(e.data.photo_description),$(c).find("input[name='photo_tags']").val(e.data.photo_tags).attr("id","tags"+d),$(c).find("select[name='collection_id']").val(e.data.collection_id).prop("disabled",!0),$(c).find("input[name='allow_comments'][value='"+e.data.allow_comments+"']").prop("checked",!0),$(c).find("input[name='allow_embedding'][value='"+e.data.allow_embedding+"']").prop("checked",!0),$(c).find("input[name='allow_rating'][value='"+e.data.allow_rating+"']").prop("checked",!0),$(c).find("img").attr("src",e.data.photoThumb);var o=document.createElement("input");o.name="photo_id",o.type="hidden",o.value=e.data.photo_id,$(c).append(o);var l=document.createElement("ul");l.id="list_tags_"+d,$(l).insertAfter($(c).find("input[name='photo_tags']")),100===e.percent&&$(c).find(".savePhotoDetails").removeAttr("disabled");var u=!1;$(c).find("#list_tags_"+d).tagit({singleField:!0,readOnly:!1,singleFieldNode:$(c).find("#tags"+d),animate:!0,caseSensitive:!1,availableTags:available_tags,beforeTagAdded:function(e,a){if(a.tagLabel.length<=2)return u||(u=!0,alert(tag_too_short)),!1;u=!1}}),t.appendChild(c),p.push(t),i.id=d++,i.appendChild(a),s.appendChild(i)}),$("#files").html("").append(s),$("#allUploadForms").html("").append(p),$("#allUploadForms input, #allUploadForms textarea, #allUploadForms select ").change(function(){var e,a=$(this).closest("form").find("input[name='file_name']").val(),t=$(this).attr("name");"checkbox"!==$(this).attr("type")?e=$(this).val():(e=[],$.each($(this).closest("form").find("input[name='"+t+"']:checked"),function(){e.push($(this).val())})),plupload.each(n.files,function(o){o.file_name===a&&(o.data[t]=e)})}),l=collection_id||$("#SelectionDIV select").val(),$(".updatePhotoInfoForm").on({submit:function(e){e.preventDefault();var a=$(this).serialize();a+="&collection_id="+l,a+="&updatePhoto=yes",$.ajax({url:"/actions/photo_uploader.php",type:"post",data:a,success:function(e){e=$.parseJSON(e),$("#uploadMessage").removeClass("hidden"),e.error?($("#uploadMessage").html(e.error.val).attr("class","alert alert-danger container"),$("html,body").animate({scrollTop:$("body").offset().top},"medium")):($("#uploadMessage").html("Picture details are successfully updated").attr("class","alert alert-success container"),$("html,body").animate({scrollTop:$("body").offset().top},"medium"),setTimeout(function(){$("#uploadMessage").addClass("hidden")},5e3))}}).fail(function(e){console.log(e)})}}),$.each(o,function(e,a){var t=a.name,o=a.data.unique_id;$(".realProgressBars").append('<h5 class="realProgTitle_'+o+'">'+t+'</h5><button class="clearfix cancel_button btn btn-danger" to_cancel="'+o+'" style="float:right; margin-top: -8px; margin-left:10px;">Cancel Uploading</button><div class="progress"><div class="progress-bar progress-bar-striped progress-bar_'+o+'" role="progressbar" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100" style="width:0%"><span class="sr-only">70% Complete</span><span class="realProgText_'+o+'">50% completed</span></div></div>')}),$(".cancel_button").on("click",function(e){e.preventDefault();var a=$(this).attr("to_cancel");$(this).attr("disabled",!0),$(this).text("Canceled"),t.abort(a),hideSpinner(),$(this).unbind().remove(),$(".progress-bar_"+a).addClass("progress-bar-danger"),$(".realProgText_"+a).text("Canceled"),$("#uploadMessage").removeClass("hidden").html("Upload has been canceled").attr("class","alert alert-danger container"),setTimeout(function(){$("#uploadMessage").addClass("hidden")},5e3)}),$(document).bind("chunkuploaded",function(e,o){let n=$.parseJSON(o.response),l=o._options.params.unique_id;n.error&&(a=n.error,t.abort(l),hideSpinner(),$(".progress-bar_"+l).addClass("progress-bar-danger"),$(".realProgText_"+l).text("Upload failed"),$(".cancel_button[to_cancel='"+l+"']").attr("disabled",!0),setTimeout(function(){$("#uploadMessage").html(n.error).addClass("hidden")},5e3))}),uploader.bind("UploadProgress",function(e,a){var t=a.data.unique_id,o=a.percent;$(".progress-bar_"+t).css("width",o+"%"),$(".realProgText_"+t).text(o+"% Completed"),100!==o||($(".cancel_button[to_cancel='"+t+"']").attr("disabled",!0).fadeOut("slow"),$(".progress-bar_"+t).hasClass("progress-bar-danger")||$(".progress-bar_"+t).addClass("progress-bar-success"))}),setTimeout(function(){$(".upload-area").addClass("hidden"),$(".form_header").addClass("hidden"),$("#uploadDataContainer").removeClass("hidden"),$(".uploadingProgressContainer").removeClass("hidden"),$("#uploadedFilesInfo").text("Uploaded 0 of "+e.length),$(".allProgress").removeClass("hidden"),uploader.start()},1e3),$("#allUploadForms").css("display","block")}),uploader.bind("BeforeUpload",function(e,a){$("#fileUploadProgress").removeClass("hidden"),$(".progress-container").removeClass("hidden"),showSpinner(),$.extend(e.settings.params,{unique_id:a.data.unique_id})});var t=0;uploader.bind("UploadProgress",function(e,a){$("#progressNumber").text(a.percent+"%"),$("#videoNumber").text(a.name)}),uploader.bind("FileUploaded",function(a,o,n){$("#overallProgress").css("width",100/e.length*++t+"%"),$("#overallProgress").parents(".row").find("#uploadedFilesInfo").text("Uploaded "+t+" of "+e.length);var l,s=$.parseJSON(n.response);l=collection_id||$("#SelectionDIV select").val();var i=0,d=0;plupload.each(a.files,function(e){i++,e.id===o.id&&(d=i)}),$.ajax({url:"/actions/photo_uploader.php",type:"post",data:{insertPhoto:"yes",title:o.name,file_name:s.file_name,collection_id:l,ext:s.extension,photo_title:o.name,photo_description:o.name,photo_tags:""},dataType:"JSON",success:function(e){var a=document.createElement("input");a.name="photo_id",a.type="hidden",a.value=e.photoID,hideSpinner(),$("#tab"+d+" form").append(a),$("#tab"+d+" form").find(".edit-img-thumbnail > img").prop("src",e.photoPreview),$("#tab"+d+" .savePhotoDetails").removeAttr("disabled"),o.data.photoThumb=e.photoPreview,o.data.photo_id=e.photoID}})}),uploader.bind("UploadComplete",function(e,a){$("#fileUploadProgress").addClass("hidden"),$("#uploadMore").removeClass("hidden"),$(".uploadingProgressContainer").addClass("hidden"),uploader.refresh(),$("#uploadMessage").html("All Files are uploaded Successfully").attr("class","alert alert-success container"),setTimeout(function(){$("#uploadMessage").addClass("hidden")},5e3)}),uploader.bind("error",function(e,a){$("#uploadMessage").removeClass("hidden"),a&&$("#uploadMessage").html(a.message).attr("class","alert alert-danger container"),setTimeout(function(){$("#uploadMessage").addClass("hidden")},8e3)}),$("#addNewCollection").on({click:function(e){e.preventDefault();var a=$(this).parents("form").serialize();a+="&mode=add_collection";var t=$(this).parents("form").find("#collection_name").val();$.ajax({type:"post",url:"/ajax.php",data:a,success:function(e){if(null===(e=$.parseJSON(e)).err||void 0===e.err){var a=document.createElement("option");a.value=parseInt(e.id),a.innerHTML=t,a.selected=!0,$("select[name='collection_id']").get(0).appendChild(a),$("#collectionSelection").get(0).appendChild(a.cloneNode(!0)),$("#collectionSelection option").last().attr("selected","selected"),$("#uploadMessage").html(e.msg).attr("class","alert alert-success container").removeClass("hidden"),$("#CollectionDIV").toggle("fast"),$(".form_header").show(),$(".upload-area").show(),$("#collectionSelection").parent().show(),$("#SelectionDIV").find(".alert-danger").hide(),setTimeout(function(){$("#uploadMessage").addClass("hidden")},5e3)}else e.err,$("#uploadMessage").html(e.err).attr("class","alert alert-danger container").removeClass("hidden"),setTimeout(function(){$("#uploadMessage").addClass("hidden")},5e3)}})}}),$("#createNewCollection").on({click:function(e){e.preventDefault(),$("#CollectionDIV").toggle("fast").find("form")[0].reset(),$(".tagit li:not(.tagit-new)").remove(),$(".form_header").hide(),$(".upload-area").hide()}}),$("#cancelAddCollection").on({click:function(e){e.preventDefault(),$("#CollectionDIV").toggle("fast"),$(".form_header").show(),$(".upload-area").show()}}),$("#selectedFilesList a").on({click:function(e){e.preventDefault(),$(this).tab("show")}}),$("#SelectionDIV select").on({change:function(e){var a=$("#collectionId");if(a)$(a).val(this.value);else{var t=document.createElement("input");t.type="hidden",t.name="collection_id",t.value=this.value,$("#allUploadForms form").each(function(e,a){$(a).get(0).appendChild(t)})}}}),$("#uploadMorePhotos").on({click:function(e){e.preventDefault(),$(".upload-area").removeClass("hidden"),$(".form_header").removeClass("hidden"),$("#uploadDataContainer").addClass("hidden")}}),init_tags("collection_tags",available_collection_tags)});
