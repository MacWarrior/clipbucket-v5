var uploader,intervalId,ids_to_check_progress=[],players=[];function getInfoTmdb(e,a,t,i,d,n){showSpinner(),$.ajax({url:baseurl+"actions/info_tmdb.php",type:"POST",data:{videoid:e,video_title:t,type:a,page:i,sort:d,sort_order:n},dataType:"json",success:function(e){hideSpinner();var a=$("#myModal");a.html(e.template),a.modal(),$(".page-content").prepend(e.msg)}})}function saveInfoTmdb(e,a,t){showSpinner(),$.ajax({url:baseurl+"actions/import_tmdb.php",type:"POST",data:{tmdb_video_id:e,videoid:t,type:a},dataType:"json",success:function(e){var d;$(".close").click(),hideSpinner(),0==e.success?$(".page-content").prepend(e.msg):(d=1,plupload.each(uploader.files,function(i){i.file_name===e.video_detail.file_name&&$.each(e.video_detail,function(e,a){i.data[e]=a;var t=$("#tab"+d).find('[name="'+e+'"]').first();0<t.length&&(e.includes("tag")&&"string"==typeof a?(e=a.split(","),$.each(e,function(e,a){""!==a&&t.parent().find("ul").first().tagit("createTag",a)})):t.val(a))}),d++}))}})}function getUpdate(){clearInterval(intervalId),0<ids_to_check_progress.length&&(intervalId=setInterval(function(){$.post({url:baseurl+"actions/progress_video.php",dataType:"json",data:{ids:ids_to_check_progress,output:"watch_video",display_thumbs:!0,display_subtitles:!0},success:function(e){e.data.videos.forEach(function(e){(0<e.percent||void 0===e.percent)&&(void 0!==e.thumbs&&0<e.thumbs.length&&(0===$('input[id^="videoid_"][value="'+e.videoid+'"]').parent().find('[name="default_thumb"]').length?((t=$(e.thumbs).hide()).insertBefore($('input[id^="videoid_"][value="'+e.videoid+'"]').parent().find(".pad-bottom-sm.text-right")),t.slideDown("slow")):(t=$('input[id^="videoid_"][value="'+e.videoid+'"]').parent().find('[name="default_thumb"]').parents(".formSection.clear")[0],$(t).html(e.thumbs))),void 0!==e.subtitles&&0<e.subtitles.length&&("successful"==e.status.toLowerCase()&&0===$('input[id^="videoid_"][value="'+e.videoid+'"]').parent().find("#subtitles_"+e.videoid).length?((t=$(e.subtitles).hide()).insertBefore($('input[id^="videoid_"][value="'+e.videoid+'"]').parent().find(".pad-bottom-sm.text-right")),t.slideDown("slow")):(t=$('input[id^="videoid_"][value="'+e.videoid+'"]').parent().find("#subtitles_"+e.videoid).parents(".formSection.clear")[0],$(t).html(e.subtitles))),slideFormSection());var a,t=$('input[id^="videoid_"][value="'+e.videoid+'"]').parents(".tab-pane.uploadFormContainer");"processing"===e.status.toLowerCase()?0===(a=$('.processing[data-id="'+e.videoid+'"]')).length?(players[e.videoid]=e.html,t.hasClass("active")&&t.find(".player-holder").html(e.html)):a.find("span").html(e.percent+"%"):(players[e.videoid]=e.html,t.hasClass("active")&&t.find(".player-holder video").length<=0&&t.find(".player-holder").html(e.html))}),e.all_complete&&clearInterval(intervalId)}})},3e4))}function pageInfoTmdb(e,a){let t,i;0<$(".icon-sort-up").length?(t=$(".icon-sort-up").data("type"),i="ASC"):0<$(".icon-sort-down").length&&(t=$(".icon-sort-down").data("type"),i="DESC"),getInfoTmdb(a,$("#type_tmdb").val(),$("#search_title").val(),e,t,i)}function showSpinner(){$(".taskHandler").show()}function hideSpinner(){$(".taskHandler").hide()}function slideFormSection(){$(".formSection h4").off("click").on({click:function(e){e.preventDefault(),$(this).find("i").hasClass("glyphicon-chevron-down")?($(this).find("i").removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up"),$(this).next().slideDown("slow")):($(this).find("i").removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down"),$(this).next().slideUp("slow"))}})}function getSubtitleList(e){$.post({url:baseurl+"actions/subtitle_get_list.php",dataType:"json",data:{video_id:e},success:function(e){e.data}})}function editTitle(e,a){$('table[data-id="'+a+'"]').find(".buttons-"+e).css("display","inline"),$('table[data-id="'+a+'"]').find(".edit_sub_"+e).css("display","inline"),$('table[data-id="'+a+'"]').find(".span_sub_"+e).hide()}function cancelEditTitle(e,a){$(".buttons-"+e).hide(),$(".edit_sub_"+e).hide(),$(".span_sub_"+e).show()}function saveSubtitle(e,a){showSpinner(),$.ajax({url:baseurl+"actions/subtitle_edit.php",type:"POST",data:{title:$('table[data-id="'+a+'"]').find(".edit_sub_"+e).val(),videoid:a,number:e},dataType:"json",success:function(e){$("#subtitles_"+a).html(e.template),hideSpinner(),$(".close").click(),$("#uploadMessage").parent().prepend(e.msg)}})}function deleteSubtitle(e,a){showSpinner(),confirm_it(text_confirm_sub_file.replace("%s",e))&&$.ajax({url:baseurl+"actions/subtitle_delete.php",type:"POST",data:{number:e,videoid:a},dataType:"json",success:function(e){$("#subtitles_"+a).html(e.template),$(".close").click(),$("#uploadMessage").parent().prepend(e.msg),hideSpinner()}})}$(document).ready(function(){var s=baseurl+"actions/file_uploader.php",o=(""!==uploadScriptPath&&(s=uploadScriptPath),uploader=new plupload.Uploader({browse_button:"selectFiles",dragdrop:!0,drop_element:"dragDrop",runtimes:"html5,silverlight,html4",url:s,file_data_name:"Filedata",chunk_size:!!chunk_upload&&max_upload_size,max_file_size:max_file_size,filters:{mime_types:[{title:"Video files",extensions:video_extensions}]},init:{FilesRemoved:function(e){r(e)}}}),0),l="";function r(d){var t=$("#selectedFilesList"),n=!1,s=0,o=$("#updateVideoInfoForm.template").clone(),l=!1,r=[];plupload.each(d.files,function(i){var e,a;s++,0!==$("#tab"+s).length?(t.find("#"+s).removeClass("active"),$("#tab"+s).removeClass("active")):(n=document.createElement("li"),(e=document.createElement("a")).href="#tab"+s,e.setAttribute("data-toggle","tab"),d.files.length<8?e.innerHTML="("+s+") "+i.name.substring(0,10):e.innerHTML="("+s+") ",(l=$(o).clone().get(0)).className="updateVideoInfoForm",l.id="",(a=document.createElement("div")).id="tab"+s,s===d.files.length?(n.className="active",a.className="tab-pane active uploadFormContainer"):a.className="tab-pane uploadFormContainer",$(l).find(".cancel_button").attr("to_cancel",s),$(l).find("input[name='title']").val(i.data.title),$(l).find("textarea[name='description']").val(i.data.description),$(l).find("input[name='location']").val(i.data.location),$(l).find("input[name='datecreated']").val(i.data.datecreated),$(l).find("input[name='video_password']").val(i.data.video_password),$(l).find("select[name='country']").val(i.data.country),$(l).find("textarea[name='video_users']").val(i.data.video_users),$(l).find("input[name='broadcast'][value='"+i.data.broadcast+"']").prop("checked",!0),$(l).find("input[name='allow_comments'][value='"+i.data.allow_comments+"']").prop("checked",!0),$(l).find("input[name='comment_voting'][value='"+i.data.comment_voting+"']").prop("checked",!0),$(l).find("input[name='allow_rating'][value='"+i.data.allow_rating+"']").prop("checked",!0),$(l).find("input[name='allow_embedding'][value='"+i.data.allow_embedding+"']").prop("checked",!0),$(l).find("[id^=tags]").each(function(e){var a=document.createElement("ul"),t=(a.id="list_"+this.id+"_"+s,$(this).val(i.data[this.name]).attr("id",this.name+s),$(a).insertAfter($(l).find("input[name='"+this.name+"']")),!1);$(l).find("#"+a.id).tagit({singleField:!0,readOnly:!1,singleFieldNode:$(l).find("#"+this.id),animate:!0,caseSensitive:!1,availableTags:available_tags,allowSpaces:allow_tag_space,beforeTagAdded:function(e,a){if(a.tagLabel.length<=2)return t||(t=!0,alert(tag_too_short)),!1;t=!1}})}),$(l).find("#list_video_users").tagit({singleField:!0,fieldName:"tags",readOnly:!1,singleFieldNode:$(l).find("#video_users"),animate:!0,caseSensitive:!1,allowSpaces:allow_username_spaces,beforeTagAdded:function(e,a){if(a.tagLabel.length<=2)return alert_shown||(alert_shown=!0,alert(tag_too_short)),!1;alert_shown=!1}}),$(l).find("#video_password").attr("disabled","disabled").parent().slideUp(),$(l).find("#video_users").attr("disabled","disabled").parent().slideUp(),$(l).find('[name="broadcast"]').off("click").on("click",function(){("unlisted"===$(this).val()?($(this).closest("form").find("#video_password").attr("disabled",!1).parent().slideDown(),$(this).closest("form").find("#video_users")):"private"===$(this).val()?($(this).closest("form").find("#video_users").attr("disabled",!1).parent().slideDown(),$(this).closest("form").find("#video_password")):($(this).closest("form").find("#video_password").attr("disabled","disabled").parent().slideUp(),$(this).closest("form").find("#video_users"))).attr("disabled","disabled").parent().slideUp()}),$(l).find("#button_info_tmdb").on("click",function(){getInfoTmdb($(l).find("#videoid_"+s).val(),"movie",i.data.title,1)}),"unlisted"===i.data.broadcast?$(l).find("#video_password").attr("disabled",!1):"private"===i.data.broadcast&&$(l).find("#video_users").attr("disabled",!1),$.each(i.data["category[]"],function(e,a){$(l).find("input[name='category[]'][value='"+a+"']").prop("checked",!0)}),!0===i.show_duration&&$(l).find("#duration").removeAttr("disabled").parent().removeClass("hidden"),100===i.percent&&$(l).find(".saveVideoDetails").removeAttr("disabled"),a.appendChild(l),r.push(a),n.id=s,n.appendChild(e),t.append(n))}),$("#allUploadForms").append(r),$("#allUploadForms input, #allUploadForms textarea, #allUploadForms select ").change(function(){var a,t=$(this).closest("form").find("input[name='file_name']").val(),i=$(this).attr("name");"checkbox"!==$(this).attr("type")?a=$(this).val():(a=[],$.each($(this).closest("form").find("input[name='"+i+"']:checked"),function(){a.push($(this).val())})),plupload.each(d.files,function(e){e.file_name===t&&(e.data[i]=a)})})}uploader.init(),uploader.bind("FilesAdded",function(a,t){let i;for($("#uploadMore").addClass("hidden"),i=0;i<t.length;i++){var d=t[i].name;let e=d.substring(0,d.lastIndexOf("."));e.length>max_video_title&&(e=e.substring(0,max_video_title)),t[i].data=[],t[i].data.title=e,t[i].data.description=e,t[i].data.tags="",t[i].data.country=default_country_iso2,t[i].data.location="",t[i].data.datecreated=date_format_time,t[i].data.broadcast="",t[i].data.video_password="",t[i].data.video_users="",t[i].data.allow_comments="yes",t[i].data.comment_voting="yes",t[i].data.allow_rating="yes",t[i].data.allow_embedding="yes","undefined"!=typeof collection_id&&(t[i].data.collection_id=collection_id),t[i].data["category[]"]=[get_default_cid],t[i].data.unique_id=(Math.random()+1).toString(36).substring(7)}r(a),$.each(t,function(e,a){var t=a.name,a=a.data.unique_id,t='<h5 class="realProgTitle_'+a+'">'+t+'</h5><button class="clearfix cancel_button btn btn-danger" to_cancel="'+a+'" style="float:right; margin-top: -8px; margin-left:10px;">'+cancel_uploading+'</button><div class="progress"><div class="progress-bar progress-bar-striped progress-bar_'+a+'" role="progressbar" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100" style="width:0;"><span class="realProgText_'+a+'"></span></div></div>';$(".realProgressBars").append(t)});var e,n=1;for(i=0;i<a.files.length;i++)void 0!==a.files[i].file_name&&((e=document.createElement("input")).name="file_name",e.type="hidden",e.value=a.files[i].file_name,$("#tab"+n+" form").append(e)),!0===a.files[i].show_duration&&$("#tab"+n+" #duration").removeAttr("disabled").parent().removeClass("hidden"),a.files[i].percent<100&&$("#tab"+n+" .saveVideoDetails").attr("disabled",!0),n++;slideFormSection(),$(".cancel_button").on("click",function(e){e.preventDefault();e=$(this).attr("to_cancel");$(this).attr("disabled",!0),$(this).text("Canceled"),a.abort(e),$(this).unbind().remove(),$(".progress-bar_"+e).addClass("progress-bar-danger"),$(".realProgText_"+e).text("Canceled"),$("#uploadMessage").removeClass("hidden").html("Upload has been canceled").attr("class","alert alert-danger container"),setTimeout(function(){$("#uploadMessage").addClass("hidden")},5e3)}),$("#uploaderContainer").toggleClass("hidden"),$("#uploadDataContainer").toggleClass("hidden"),$(".uploadingProgressContainer").show(),$(".allProgress").removeClass("hidden"),a.start()}),uploader.bind("BeforeUpload",function(e,a){$("#fileUploadProgress").removeClass("hidden"),$(".progress-container").removeClass("hidden"),$.extend(e.settings.params,{unique_id:a.data.unique_id,collection_id:a.data.collection_id})}),uploader.bind("FileUploaded",function(e,t,a){var i=$.parseJSON(a.response),d="",n=(i.error?(l=i.error,$(".progress-bar_"+t.id).addClass("progress-bar-danger"),d=t.id):o++,$("#overallProgress").css("width",100/e.files.length*o+"%"),$("#overallProgress").parents(".row").find("#uploadedFilesInfo").text("Inserted "+o+" of "+e.files.length),1);plupload.each(e.files,function(e){var a;e.id===t.id&&(d===e.id?$("#tab"+n+" form").find(":input").attr("disabled","disabled"):(e.file_name=i.file_name,(a=document.createElement("input")).name="file_name",a.id="file_name_"+n,a.type="hidden",a.value=i.file_name,$("#tab"+n+" form").append(a),(a=document.createElement("input")).name="videoid",a.id="videoid_"+n,a.type="hidden",a.value=i.videoid,ids_to_check_progress.push(i.videoid),0===$("#"+a.id).length&&$("#tab"+n+" form").append(a),"mp4"===i.extension&&"yes"===stay_mp4?(e.show_duration=!0,$("#tab"+n+" #duration").removeAttr("disabled").parent().removeClass("hidden")):e.show_duration=!1,$("#"+n+" a").on("click",function(){$(".player-holder video").each(function(e,a){videojs(a).dispose()}),$(".player-holder").html("");var e=$(this).parent().attr("id"),a=$("#videoid_"+e).val();$("#tab"+e).find(".player-holder").html(players[a])}),$("#tab"+n+" .saveVideoDetails").removeAttr("disabled"),getUpdate())),n++}),$(".updateVideoInfoForm").on({submit:function(e){e.preventDefault();e=$(this).serialize();e+="&updateVideo=yes",$.ajax({url:s,type:"post",data:e,success:function(e){e=$.parseJSON(e),$("#uploadMessage").removeClass("hidden"),e.error?$("#uploadMessage").html(e.error.val).attr("class","alert alert-danger container"):($("#uploadMessage").html(e.valid).attr("class","alert alert-success container"),$("#tab"+n+" .saveVideoDetails").attr("disabled",!0),setTimeout(function(){$("#uploadMessage").addClass("hidden")},4e3)),$("html,body").animate({scrollTop:$("body").offset().top},"medium")}}).fail(function(e){console.log(e)})}})}),$(document).bind("chunkuploaded",function(e,a){let t=$.parseJSON(a.response);a=a._options.params.unique_id;t.error&&(l=t.error,uploader.abort(a),$(".progress-bar_"+a).addClass("progress-bar-danger"),$(".realProgText_"+a).text("Upload failed"),$(".cancel_button[to_cancel='"+a+"']").attr("disabled",!0),setTimeout(function(){$("#uploadMessage").html(t.error).addClass("hidden")},5e3))}),uploader.bind("UploadProgress",function(e,a){var t=a.data.unique_id,a=a.percent;$(".progress-bar_"+t).css("width",a+"%"),$(".realProgText_"+t).text(a+pourcent_completed),100===a&&($(".cancel_button[to_cancel='"+t+"']").attr("disabled",!0).fadeOut("slow"),$(".progress-bar_"+t).hasClass("progress-bar-danger")||$(".progress-bar_"+t).addClass("progress-bar-success"))}),uploader.bind("UploadComplete",function(e,a){$("#fileUploadProgress").addClass("hidden"),$("#uploadMore").removeClass("hidden"),$(".uploadingProgressContainer").hide(),uploader.refresh(),0<l.length?($("#uploadMessage").html(""),$("#uploadMessage").append(l).attr("class","alert alert-danger container"),l=""):($("#uploadMessage").html("File uploaded successfully").attr("class","alert alert-success container"),setTimeout(function(){$("#uploadMessage").addClass("hidden")},5e3))}),uploader.bind("Error",function(e,a){$("#uploadMessage").removeClass("hidden"),a&&$("#uploadMessage").html(a.message).attr("class","alert alert-danger container"),setTimeout(function(){$("#uploadMessage").addClass("hidden")},8e3)}),$("#files a").click(function(e){e.preventDefault(),$(this).tab("show")}),$("#uploadMoreVideos").on({click:function(e){e.preventDefault(),$("#uploaderContainer").removeClass("hidden"),$("#uploadDataContainer").addClass("hidden")}}),window.onbeforeunload=function(){return!0===$(".uploadingProgressContainer").is(":visible")?"Uploading is in progress, are you sure you want to navigate away from this page?":null}});