var uploader;function getInfoTmdb(e,a,t,n,i,d){showSpinner(),$.ajax({url:"/actions/info_tmdb.php",type:"POST",data:{videoid:e,video_title:a,page:t,sort:n,sort_order:i},dataType:"json",success:function(e){hideSpinner();var a=$("#myModal");a.html(e.template),a.modal(),$(".page-content").prepend(e.msg)}})}function saveInfoTmdb(e,a){showSpinner(),$.ajax({url:"/actions/import_tmdb.php",type:"POST",data:{tmdb_video_id:e,videoid:a},dataType:"json",success:function(e){if($(".close").click(),hideSpinner(),!1==e.success)$(".page-content").prepend(e.msg);else{var a=1;plupload.each(uploader.files,function(t){t.file_name===e.video_detail.file_name&&$.each(e.video_detail,function(e,n){t.data[e]=n;var i=$("#tab"+a).find('[name="'+e+'"]').first();if(i.length>0){if(e.includes("tag")){var d=n.split(",");$.each(d,function(e,a){""!==a&&i.parent().find("ul").first().tagit("createTag",a)})}else i.val(n)}}),a++})}}})}function pageInfoTmdb(e,a){let t,n;$(".icon-sort-up").length>0?(t=$(".icon-sort-up").data("type"),n="ASC"):$(".icon-sort-down").length>0&&(t=$(".icon-sort-down").data("type"),n="DESC"),getInfoTmdb(a,$("#search_title").val(),e,t,n)}function showSpinner(){$(".taskHandler").show()}function hideSpinner(){$(".taskHandler").hide()}$(document).ready(function(){var e="/actions/file_uploader.php";""!==uploadScriptPath&&(e=uploadScriptPath);var a=back_extensions;a=a.substring(0,a.length-1),uploader=new plupload.Uploader({browse_button:"selectFiles",dragdrop:!0,drop_element:"dragDrop",runtimes:"html5,silverlight,html4",url:e,file_data_name:"Filedata",chunk_size:!!chunk_upload&&max_upload_size,max_file_size:max_file_size,filters:{mime_types:[{title:"Video files",extensions:a}]},init:{FilesRemoved:function(e){i(e)}}});var t=0,n="";function i(e){var a=$("#selectedFilesList"),t=!1,n=0,i=$("#updateVideoInfoForm.template").clone(),d=!1,s=[];plupload.each(e.files,function(o){if(0===$("#tab"+ ++n).length)t=document.createElement("li");else{a.find("#"+n).removeClass("active"),$("#tab"+n).removeClass("active");return}var r=document.createElement("a");r.href="#tab"+n,r.setAttribute("data-toggle","tab"),e.files.length<8?r.innerHTML="("+n+") "+o.name.substring(0,10):r.innerHTML="("+n+") ",(d=$(i).clone().get(0)).className="updateVideoInfoForm",d.id="";var l=document.createElement("div");l.id="tab"+n,n===e.files.length?(t.className="active",l.className="tab-pane active uploadFormContainer"):l.className="tab-pane uploadFormContainer",$(d).find(".cancel_button").attr("to_cancel",n),$(d).find("input[name='title']").val(o.data.title),$(d).find("textarea[name='description']").val(o.data.description),$(d).find("input[name='location']").val(o.data.location),$(d).find("input[name='datecreated']").val(o.data.datecreated),$(d).find("input[name='video_password']").val(o.data.video_password),$(d).find("select[name='country']").val(o.data.country),$(d).find("textarea[name='video_users']").val(o.data.video_users),$(d).find("input[name='broadcast'][value='"+o.data.broadcast+"']").prop("checked",!0),$(d).find("input[name='allow_comments'][value='"+o.data.allow_comments+"']").prop("checked",!0),$(d).find("input[name='comment_voting'][value='"+o.data.comment_voting+"']").prop("checked",!0),$(d).find("input[name='allow_rating'][value='"+o.data.allow_rating+"']").prop("checked",!0),$(d).find("input[name='allow_embedding'][value='"+o.data.allow_embedding+"']").prop("checked",!0),$(d).find("[id^=tags]").each(function(e){var a=document.createElement("ul");a.id="list_"+this.id+"_"+n,$(this).val(o.data[this.name]).attr("id",this.name+n),$(a).insertAfter($(d).find("input[name='"+this.name+"']"));var t=!1;$(d).find("#"+a.id).tagit({singleField:!0,readOnly:!1,singleFieldNode:$(d).find("#"+this.id),animate:!0,caseSensitive:!1,availableTags:available_tags,beforeTagAdded:function(e,a){if(a.tagLabel.length<=2)return t||(t=!0,alert(tag_too_short)),!1;t=!1}})}),$(d).find("#button_info_tmdb").on("click",function(){getInfoTmdb($(d).find("#videoid_"+n).val(),o.data.title,1)}),"unlisted"===o.data.broadcast?$(d).find("#video_password").attr("disabled",!1):"private"===o.data.broadcast&&$(d).find("#video_users").attr("disabled",!1),$.each(o.data["category[]"],function(e,a){$(d).find("input[name='category[]'][value='"+a+"']").prop("checked",!0)}),!0===o.show_duration&&$(d).find("#duration").removeAttr("disabled").parent().removeClass("hidden"),100===o.percent&&$(d).find(".saveVideoDetails").removeAttr("disabled"),l.appendChild(d),s.push(l),t.id=n,t.appendChild(r),a.append(t)}),$("#allUploadForms").append(s),$("#allUploadForms input, #allUploadForms textarea, #allUploadForms select ").change(function(){var a,t=$(this).closest("form").find("input[name='file_name']").val(),n=$(this).attr("name");"checkbox"!==$(this).attr("type")?a=$(this).val():(a=[],$.each($(this).closest("form").find("input[name='"+n+"']:checked"),function(){a.push($(this).val())})),plupload.each(e.files,function(e){e.file_name===t&&(e.data[n]=a)})})}uploader.init(),uploader.bind("FilesAdded",function(e,a){let t;for($("#uploadMore").addClass("hidden"),t=0;t<a.length;t++){let n=a[t].name,d=n.substring(0,n.lastIndexOf("."));d.length>max_video_title&&(d=d.substring(0,max_video_title)),a[t].data=[],a[t].data.title=d,a[t].data.description=d,a[t].data.tags="",a[t].data.country=default_country_iso2,a[t].data.location="",a[t].data.datecreated=date_format_time,a[t].data.broadcast="",a[t].data.video_password="",a[t].data.video_users="",a[t].data.allow_comments="yes",a[t].data.comment_voting="yes",a[t].data.allow_rating="yes",a[t].data.allow_embedding="yes","undefined"!=typeof collection_id&&(a[t].data.collection_id=collection_id),a[t].data["category[]"]=[get_default_cid],a[t].data.unique_id=(Math.random()+1).toString(36).substring(7)}i(e),$.each(a,function(e,a){var t=a.name,n=a.data.unique_id;let i='<h5 class="realProgTitle_'+n+'">'+t+'</h5><button class="clearfix cancel_button btn btn-danger" to_cancel="'+n+'" style="float:right; margin-top: -8px; margin-left:10px;">'+cancel_uploading+'</button><div class="progress"><div class="progress-bar progress-bar-striped progress-bar_'+n+'" role="progressbar" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100" style="width:0;"><span class="realProgText_'+n+'"></span></div></div>';$(".realProgressBars").append(i)});var s=1;for(t=0;t<e.files.length;t++){if(void 0!==e.files[t].file_name){var o=document.createElement("input");o.name="file_name",o.type="hidden",o.value=e.files[t].file_name,$("#tab"+s+" form").append(o)}!0===e.files[t].show_duration&&$("#tab"+s+" #duration").removeAttr("disabled").parent().removeClass("hidden"),e.files[t].percent<100&&$("#tab"+s+" .saveVideoDetails").attr("disabled",!0),s++}$(".formSection h4").on({click:function(e){e.preventDefault(),$(this).find("i").hasClass("glyphicon-chevron-down")?($(this).find("i").removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up"),$(this).next().toggleClass("hidden")):($(this).find("i").removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down"),$(this).next().toggleClass("hidden"))}}),$(".cancel_button").on("click",function(a){a.preventDefault();var t=$(this).attr("to_cancel");$(this).attr("disabled",!0),$(this).text("Canceled"),e.abort(t),$(this).unbind().remove(),$(".progress-bar_"+t).addClass("progress-bar-danger"),$(".realProgText_"+t).text("Canceled"),$("#uploadMessage").removeClass("hidden").html("Upload has been canceled").attr("class","alert alert-danger container"),setTimeout(function(){$("#uploadMessage").addClass("hidden")},5e3)}),$("#uploaderContainer").toggleClass("hidden"),$("#uploadDataContainer").toggleClass("hidden"),$(".uploadingProgressContainer").show(),$(".allProgress").removeClass("hidden"),e.start()}),uploader.bind("BeforeUpload",function(e,a){$("#fileUploadProgress").removeClass("hidden"),$(".progress-container").removeClass("hidden"),$.extend(e.settings.params,{unique_id:a.data.unique_id,collection_id:a.data.collection_id})}),uploader.bind("FileUploaded",function(a,i,d){var s=$.parseJSON(d.response),o="";s.error?(n=s.error,$(".progress-bar_"+i.id).addClass("progress-bar-danger"),o=i.id):t++,$("#overallProgress").css("width",100/a.files.length*t+"%"),$("#overallProgress").parents(".row").find("#uploadedFilesInfo").text("Inserted "+t+" of "+a.files.length);var r=1;plupload.each(a.files,function(e){if(e.id===i.id){if(o===e.id)$("#tab"+r+" form").find(":input").attr("disabled","disabled");else{e.file_name=s.file_name;var a=document.createElement("input");a.name="file_name",a.id="file_name_"+r,a.type="hidden",a.value=s.file_name,$("#tab"+r+" form").append(a);var t=document.createElement("input");t.name="videoid",t.id="videoid_"+r,t.type="hidden",t.value=s.videoid,0===$("#"+t.id).length&&$("#tab"+r+" form").append(t),"mp4"===s.extension&&"yes"===stay_mp4?(e.show_duration=!0,$("#tab"+r+" #duration").removeAttr("disabled").parent().removeClass("hidden")):e.show_duration=!1,$("#tab"+r+" .saveVideoDetails").removeAttr("disabled")}}r++}),$(".updateVideoInfoForm").on({submit:function(a){a.preventDefault();var t=$(this).serialize();t+="&updateVideo=yes",$.ajax({url:e,type:"post",data:t,success:function(e){e=$.parseJSON(e),$("#uploadMessage").removeClass("hidden"),e.error?$("#uploadMessage").html(e.error.val).attr("class","alert alert-danger container"):($("#uploadMessage").html(e.valid).attr("class","alert alert-success container"),$("#tab"+r+" .saveVideoDetails").attr("disabled",!0),setTimeout(function(){$("#uploadMessage").addClass("hidden")},4e3)),$("html,body").animate({scrollTop:$("body").offset().top},"medium")}}).fail(function(e){console.log(e)})}})}),$(document).bind("chunkuploaded",function(e,a){let t=$.parseJSON(a.response),i=a._options.params.unique_id;t.error&&(n=t.error,uploader.abort(i),$(".progress-bar_"+i).addClass("progress-bar-danger"),$(".realProgText_"+i).text("Upload failed"),$(".cancel_button[to_cancel='"+i+"']").attr("disabled",!0),setTimeout(function(){$("#uploadMessage").html(t.error).addClass("hidden")},5e3))}),uploader.bind("UploadProgress",function(e,a){var t=a.data.unique_id,n=a.percent;$(".progress-bar_"+t).css("width",n+"%"),$(".realProgText_"+t).text(n+pourcent_completed),100!==n||($(".cancel_button[to_cancel='"+t+"']").attr("disabled",!0).fadeOut("slow"),$(".progress-bar_"+t).hasClass("progress-bar-danger")||$(".progress-bar_"+t).addClass("progress-bar-success"))}),uploader.bind("UploadComplete",function(e,a){$("#fileUploadProgress").addClass("hidden"),$("#uploadMore").removeClass("hidden"),$(".uploadingProgressContainer").hide(),uploader.refresh(),n.length>0?($("#uploadMessage").html(""),$("#uploadMessage").append(n).attr("class","alert alert-danger container"),n=""):($("#uploadMessage").html("File uploaded successfully").attr("class","alert alert-success container"),setTimeout(function(){$("#uploadMessage").addClass("hidden")},5e3))}),uploader.bind("Error",function(e,a){$("#uploadMessage").removeClass("hidden"),a&&$("#uploadMessage").html(a.message).attr("class","alert alert-danger container"),setTimeout(function(){$("#uploadMessage").addClass("hidden")},8e3)}),$("#files a").click(function(e){e.preventDefault(),$(this).tab("show")}),$("#uploadMoreVideos").on({click:function(e){e.preventDefault(),$("#uploaderContainer").removeClass("hidden"),$("#uploadDataContainer").addClass("hidden")}}),window.onbeforeunload=function(){return!0===$(".uploadingProgressContainer").is(":visible")?"Uploading is in progress, are you sure you want to navigate away from this page?":null}});
