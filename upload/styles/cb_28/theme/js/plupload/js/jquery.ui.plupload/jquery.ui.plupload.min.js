!function(_,c){function o(t){return _.translate(t)||t}c.widget("ui.plupload",{widgetEventPrefix:"",contents_bak:"",options:{browse_button_hover:"ui-state-hover",browse_button_active:"ui-state-active",filters:{},buttons:{browse:!0,start:!0,stop:!0},views:{list:!0,thumbs:!1,active:"list",remember:!0},thumb_width:100,thumb_height:60,multiple_queues:!0,dragdrop:!0,autostart:!1,sortable:!1,rename:!1},FILE_COUNT_ERROR:-9001,_create:function(){var t,e=this.element.attr("id");e||(e=_.guid(),this.element.attr("id",e)),this.id=e,this.contents_bak=this.element.html(),(t=this.element).id=t.attr("id"),t.html('<div class="plupload_wrapper"><div class="ui-widget-content plupload_container"><div class="ui-state-default ui-widget-header plupload_header"><div class="plupload_header_content"><div class="plupload_logo"> </div><div class="plupload_header_title">'+o("Select files")+'</div><div class="plupload_header_text">'+o("Add files to the upload queue and click the start button.")+'</div><div class="plupload_view_switch"><input type="radio" id="'+t.id+'_view_list" name="view_mode_'+t.id+'" checked="checked" /><label class="plupload_button" for="'+t.id+'_view_list" data-view="list">'+o("List")+'</label><input type="radio" id="'+t.id+'_view_thumbs" name="view_mode_'+t.id+'" /><label class="plupload_button"  for="'+t.id+'_view_thumbs" data-view="thumbs">'+o("Thumbnails")+'</label></div></div></div><table class="plupload_filelist plupload_filelist_header ui-widget-header"><tr><td class="plupload_cell plupload_file_name">'+o("Filename")+'</td><td class="plupload_cell plupload_file_status">'+o("Status")+'</td><td class="plupload_cell plupload_file_size">'+o("Size")+'</td><td class="plupload_cell plupload_file_action">&nbsp;</td></tr></table><div class="plupload_content"><div class="plupload_droptext">'+o("Drag files here.")+'</div><ul class="plupload_filelist_content"> </ul><div class="plupload_clearer">&nbsp;</div></div><table class="plupload_filelist plupload_filelist_footer ui-widget-header"><tr><td class="plupload_cell plupload_file_name"><div class="plupload_buttons">\x3c!-- Visible --\x3e<a class="plupload_button plupload_add">'+o("Add Files")+'</a>&nbsp;<a class="plupload_button plupload_start">'+o("Start Upload")+'</a>&nbsp;<a class="plupload_button plupload_stop plupload_hidden">'+o("Stop Upload")+'</a>&nbsp;</div><div class="plupload_started plupload_hidden">\x3c!-- Hidden --\x3e<div class="plupload_progress plupload_right"><div class="plupload_progress_container"></div></div><div class="plupload_cell plupload_upload_status"></div><div class="plupload_clearer">&nbsp;</div></div></td><td class="plupload_file_status"><span class="plupload_total_status">0%</span></td><td class="plupload_file_size"><span class="plupload_total_file_size">0 kb</span></td><td class="plupload_file_action"></td></tr></table></div><input class="plupload_count" value="0" type="hidden"></div>'),this.container=c(".plupload_container",this.element).attr("id",e+"_container"),this.content=c(".plupload_content",this.element),c.fn.resizable&&this.container.resizable({handles:"s",minHeight:300}),this.filelist=c(".plupload_filelist_content",this.container).attr({id:e+"_filelist",unselectable:"on"}),this.browse_button=c(".plupload_add",this.container).attr("id",e+"_browse"),this.start_button=c(".plupload_start",this.container).attr("id",e+"_start"),this.stop_button=c(".plupload_stop",this.container).attr("id",e+"_stop"),this.thumbs_switcher=c("#"+e+"_view_thumbs"),this.list_switcher=c("#"+e+"_view_list"),c.ui.button&&(this.browse_button.button({icons:{primary:"ui-icon-circle-plus"},disabled:!0}),this.start_button.button({icons:{primary:"ui-icon-circle-arrow-e"},disabled:!0}),this.stop_button.button({icons:{primary:"ui-icon-circle-close"}}),this.list_switcher.button({text:!1,icons:{secondary:"ui-icon-grip-dotted-horizontal"}}),this.thumbs_switcher.button({text:!1,icons:{secondary:"ui-icon-image"}})),this.progressbar=c(".plupload_progress_container",this.container),c.ui.progressbar&&this.progressbar.progressbar(),this.counter=c(".plupload_count",this.element).attr({id:e+"_count",name:e+"_count"}),this._initUploader()},_initUploader:function(){var s=this,t=this.id,e={container:t+"_buttons",browse_button:t+"_browse",required_features:{},filters:{}};c(".plupload_buttons",this.element).attr("id",t+"_buttons"),s.options.dragdrop&&(this.filelist.parent().attr("id",this.id+"_dropbox"),e.drop_element=this.id+"_dropbox"),this.filelist.on("click",function(t){c(t.target).hasClass("plupload_action_icon")&&(s.removeFile(c(t.target).closest(".plupload_file").attr("id")),t.preventDefault())}),s.options.views.thumbs&&(e.required_features.display_media=!0),s.options.max_file_count&&(e.filters.max_file_count=s.options.max_file_count),t=this.uploader=(t,new _.Uploader(c.extend(this.options,e))),this.options=t.getOption(),_.addFileFilter("max_file_count",function(t,e,i){t<=this.files.length-(this.total.uploaded+this.total.failed)?(s.browse_button.button("disable"),this.disableBrowse(),this.trigger("Error",{code:s.FILE_COUNT_ERROR,message:o("File count error."),file:e}),i(!1)):i(!0)}),t.bind("Error",function(t,e){var i="",l="<strong>"+e.message+"</strong>";switch(e.code){case _.FILE_EXTENSION_ERROR:i=_.sprintf(o("File: %s"),e.file.name);break;case _.FILE_SIZE_ERROR:i=_.sprintf(o("File: %s, size: %d, max file size: %d"),e.file.name,_.formatSize(e.file.size),_.formatSize(_.parseSize(t.getOption("filters").max_file_size)));break;case _.FILE_DUPLICATE_ERROR:i=_.sprintf(o("%s already present in the queue."),e.file.name);break;case s.FILE_COUNT_ERROR:i=_.sprintf(o("Upload element accepts only %d file(s) at a time. Extra files were stripped."),t.getOption("filters").max_file_count||0);break;case _.IMAGE_FORMAT_ERROR:i=o("Image format either wrong or not supported.");break;case _.IMAGE_MEMORY_ERROR:i=o("Runtime ran out of available memory.");break;case _.HTTP_ERROR:i=o("Upload URL might be wrong or doesn't exist.")}l+=" <br /><i>"+_.xmlEncode(i)+"</i>",s._trigger("error",null,{up:t,error:e}),e.code===_.INIT_ERROR?setTimeout(function(){s.destroy()},1):s.notify("error",l)}),t.bind("PostInit",function(t){s.options.buttons.browse?s.browse_button.button("enable"):(s.browse_button.button("disable").hide(),t.disableBrowse(!0)),s.options.buttons.start||s.start_button.button("disable").hide(),s.options.buttons.stop||s.stop_button.button("disable").hide(),!s.options.unique_names&&s.options.rename&&s._enableRenaming(),s.options.dragdrop&&t.features.dragdrop&&s.filelist.parent().addClass("plupload_dropbox"),s._enableViewSwitcher(),s.start_button.click(function(t){c(this).button("option","disabled")||s.start(),t.preventDefault()}),s.stop_button.click(function(t){s.stop(),t.preventDefault()}),s._trigger("ready",null,{up:t})}),t.init(),t.bind("FileFiltered",function(t,e){s._addFiles(e)}),t.bind("FilesAdded",function(t,e){s._trigger("selected",null,{up:t,files:e}),s.options.sortable&&c.ui.sortable&&s._enableSortingList(),s._trigger("updatelist",null,{filelist:s.filelist}),s.options.autostart&&setTimeout(function(){s.start()},10)}),t.bind("FilesRemoved",function(t,e){c.ui.sortable&&s.options.sortable&&c("tbody",s.filelist).sortable("destroy"),c.each(e,function(t,e){c("#"+e.id).toggle("highlight",function(){c(this).remove()})}),t.files.length&&s.options.sortable&&c.ui.sortable&&s._enableSortingList(),s._trigger("updatelist",null,{filelist:s.filelist}),s._trigger("removed",null,{up:t,files:e})}),t.bind("QueueChanged",function(){s._handleState()}),t.bind("StateChanged",function(t){s._handleState(),_.STARTED===t.state?s._trigger("started",null,{up:this.uploader}):_.STOPPED===t.state&&s._trigger("stopped",null,{up:this.uploader})}),t.bind("UploadFile",function(t,e){s._handleFileStatus(e)}),t.bind("FileUploaded",function(t,e,i){s._handleFileStatus(e),s._trigger("uploaded",null,{up:t,file:e,result:i})}),t.bind("UploadProgress",function(t,e){s._handleFileStatus(e),s._updateTotalProgress(),s._trigger("progress",null,{up:t,file:e})}),t.bind("UploadComplete",function(t,e){s._addFormFields(),s._trigger("complete",null,{up:t,files:e})})},_setOption:function(t,e){var i=this;"buttons"==t&&"object"==typeof e&&((e=c.extend(i.options.buttons,e)).browse?(i.browse_button.button("enable").show(),i.uploader.disableBrowse(!1)):(i.browse_button.button("disable").hide(),i.uploader.disableBrowse(!0)),e.start?i.start_button.button("enable").show():i.start_button.button("disable").hide(),e.stop?i.start_button.button("enable").show():i.stop_button.button("disable").hide()),i.uploader.setOption(t,e)},start:function(){this.uploader.start()},stop:function(){this.uploader.stop()},enable:function(){this.browse_button.button("enable"),this.uploader.disableBrowse(!1)},disable:function(){this.browse_button.button("disable"),this.uploader.disableBrowse(!0)},getFile:function(t){t="number"==typeof t?this.uploader.files[t]:this.uploader.getFile(t);return t},getFiles:function(){return this.uploader.files},removeFile:function(t){"string"===_.typeOf(t)&&(t=this.getFile(t)),this.uploader.removeFile(t)},clearQueue:function(){this.uploader.splice()},getUploader:function(){return this.uploader},refresh:function(){this.uploader.refresh()},notify:function(t,e){var i=c('<div class="plupload_message"><span class="plupload_message_close ui-icon ui-icon-circle-close" title="'+o("Close")+'"></span><p><span class="ui-icon"></span>'+e+"</p></div>");i.addClass("ui-state-"+("error"===t?"error":"highlight")).find("p .ui-icon").addClass("ui-icon-"+("error"===t?"alert":"info")).end().find(".plupload_message_close").click(function(){i.remove()}).end(),c(".plupload_header",this.container).append(i)},destroy:function(){this.uploader.destroy(),c(".plupload_button",this.element).unbind(),c.ui.button&&c(".plupload_add, .plupload_start, .plupload_stop",this.container).button("destroy"),c.ui.progressbar&&this.progressbar.progressbar("destroy"),c.ui.sortable&&this.options.sortable&&c("tbody",this.filelist).sortable("destroy"),this.element.empty().html(this.contents_bak),this.contents_bak="",c.Widget.prototype.destroy.apply(this)},_handleState:function(){var t=this.uploader,e=t.files.length-(t.total.uploaded+t.total.failed),i=t.getOption("filters").max_file_count||0;_.STARTED===t.state?(c([]).add(this.stop_button).add(".plupload_started").removeClass("plupload_hidden"),this.start_button.button("disable"),this.options.multiple_queues||(this.browse_button.button("disable"),t.disableBrowse()),c(".plupload_upload_status",this.element).html(_.sprintf(o("Uploaded %d/%d files"),t.total.uploaded,t.files.length)),c(".plupload_header_content",this.element).addClass("plupload_header_content_bw")):_.STOPPED===t.state&&(c([]).add(this.stop_button).add(".plupload_started").addClass("plupload_hidden"),e?this.start_button.button("enable"):this.start_button.button("disable"),this.options.multiple_queues&&c(".plupload_header_content",this.element).removeClass("plupload_header_content_bw"),this.options.multiple_queues&&i&&e<i&&(this.browse_button.button("enable"),t.disableBrowse(!1)),this.container.toggleClass("plupload_files_queued",t.files.length),this._updateTotalProgress()),0===t.total.queued?c(".ui-button-text",this.browse_button).html(o("Add Files")):c(".ui-button-text",this.browse_button).html(_.sprintf(o("%d files queued"),t.total.queued)),t.refresh()},_handleFileStatus:function(t){var e=c("#"+t.id);if(e.length){switch(t.status){case _.DONE:i="plupload_done",l="plupload_action_icon ui-icon ui-icon-circle-check";break;case _.FAILED:i="ui-state-error plupload_failed",l="plupload_action_icon ui-icon ui-icon-alert";break;case _.QUEUED:i="plupload_delete",l="plupload_action_icon ui-icon ui-icon-circle-minus";break;case _.UPLOADING:var i="ui-state-highlight plupload_uploading",l="plupload_action_icon ui-icon ui-icon-circle-arrow-w",s=c(".plupload_scroll",this.container),o=s.scrollTop(),a=s.height(),n=e.position().top+e.height();a<n&&s.scrollTop(o+n-a),e.find(".plupload_file_percent").html(t.percent+"%").end().find(".plupload_file_progress").css("width",t.percent+"%").end().find(".plupload_file_size").html(_.formatSize(t.size))}e.attr("class",i+=" ui-state-default plupload_file").find(".plupload_action_icon").attr("class",l)}},_updateTotalProgress:function(){var t=this.uploader;this.filelist[0].scrollTop=this.filelist[0].scrollHeight,this.progressbar.progressbar("value",t.total.percent),this.element.find(".plupload_total_status").html(t.total.percent+"%").end().find(".plupload_total_file_size").html(_.formatSize(t.total.size)).end().find(".plupload_upload_status").html(_.sprintf(o("Uploaded %d/%d files"),t.total.uploaded,t.files.length))},_displayThumbs:function(){var i,l,s,o=this,a=0,n=[],d=!1;function e(t,e,i){var l;t.on(e,function(){clearTimeout(l),l=setTimeout(function(){clearTimeout(l),i()},300)})}function u(){var t=Math.floor(o.content.scrollTop()/l)*s;n=c(".plupload_file .plupload_file_thumb",o.filelist).slice(t,t+a).filter(".plupload_thumb_toload").get()}function r(){function t(){var t,e;"thumbs"===o.view_mode&&(i&&l||(t=c(".plupload_file:eq(0)",o.filelist),i=t.outerWidth(!0),l=t.outerHeight(!0)),t=o.content.width(),e=o.content.height(),s=Math.floor(t/i),a=s*(Math.ceil(e/l)+1),u(),function t(){if("thumbs"!==o.view_mode||d)return;u();if(!n.length)return;d=!0;p(o.getFile(c(n.shift()).closest(".plupload_file").attr("id")),function(){d=!1,t()})}())}c.fn.resizable&&e(o.container,"resize",t),e(o.window,"resize",t),e(o.content,"scroll",t),o.element.on("viewchanged selected",t),t()}function p(e,i){var t=new _.Image;t.onload=function(){var t=c("#"+e.id+" .plupload_file_thumb",o.filelist);this.embed(t[0],{width:o.options.thumb_width,height:o.options.thumb_height,crop:!0,fit:!0,preserveHeaders:!1,swf_url:_.resolveUrl(o.options.flash_swf_url),xap_url:_.resolveUrl(o.options.silverlight_xap_url)})},t.bind("embedded error",function(t){c("#"+e.id,o.filelist).find(".plupload_file_thumb").removeClass("plupload_thumb_loading").addClass("plupload_thumb_"+t.type),this.destroy(),setTimeout(i,1)}),c("#"+e.id,o.filelist).find(".plupload_file_thumb").removeClass("plupload_thumb_toload").addClass("plupload_thumb_loading"),t.load(e.getSource())}this.options.views.thumbs&&this.element.on("selected",function t(){o.element.off("selected",t),r()})},_addFiles:function(t){var s=this,o="";"array"!==_.typeOf(t)&&(t=[t]),c.each(t,function(t,i){var e=i.name.match(/\.([^.]+)$/),l=e&&e[1].toLowerCase()||"none";o+='<li class="plupload_file ui-state-default plupload_delete" id="{id}" style="width:{thumb_width}px;"><div class="plupload_file_thumb plupload_thumb_toload" style="width: {thumb_width}px; height: {thumb_height}px;"><div class="plupload_file_dummy ui-widget-content" style="line-height: {thumb_height}px;"><span class="ui-state-disabled">{ext} </span></div></div><div class="plupload_file_status"><div class="plupload_file_progress ui-widget-header" style="width: 0%"> </div><span class="plupload_file_percent">{percent} </span></div><div class="plupload_file_name" title="{name}"><span class="plupload_file_name_wrapper">{name} </span></div><div class="plupload_file_action"><div class="plupload_action_icon ui-icon ui-icon-circle-minus"> </div></div><div class="plupload_file_size">{size} </div><div class="plupload_file_fields"> </div></li>'.replace(/\{(\w+)\}/g,function(t,e){switch(e){case"thumb_width":case"thumb_height":return s.options[e];case"size":return _.formatSize(i.size);case"ext":return l;default:return _.xmlEncode(i[e]||"")}})}),s.filelist.append(o)},_addFormFields:function(){var l=this;c(".plupload_file_fields",this.filelist).html(""),_.each(this.uploader.files,function(t,e){var i="",e=l.id+"_"+e;t.target_name&&(i+='<input type="hidden" name="'+e+'_tmpname" value="'+_.xmlEncode(t.target_name)+'" />'),i=(i+='<input type="hidden" name="'+e+'_name" value="'+_.xmlEncode(t.name)+'" />')+'<input type="hidden" name="'+e+'_status" value="'+(t.status===_.DONE?"done":"failed")+'" />',c("#"+t.id).find(".plupload_file_fields").html(i)}),this.counter.val(this.uploader.files.length)},_viewChanged:function(t){this.options.views.remember&&c.cookie&&c.cookie("plupload_ui_view",t,{expires:7,path:"/"}),"IE"===_.ua.browser&&_.ua.version<7&&this.content.attr("style",'height:expression(document.getElementById("'+this.id+'_container").clientHeight - '+("list"===t?132:102)+")"),this.container.removeClass("plupload_view_list plupload_view_thumbs").addClass("plupload_view_"+t),this.view_mode=t,this._trigger("viewchanged",null,{view:t})},_enableViewSwitcher:function(){var e,t,i=this,l=c(".plupload_view_switch",this.container);_.each(["list","thumbs"],function(t){i.options.views[t]||l.find('[for="'+i.id+"_view_"+t+'"], #'+i.id+"_view_"+t).remove()}),1===(t=l.find(".plupload_button")).length?(l.hide(),e=t.eq(0).data("view"),this._viewChanged(e)):c.ui.button&&1<t.length?(this.options.views.remember&&c.cookie&&(e=c.cookie("plupload_ui_view")),~_.inArray(e,["list","thumbs"])||(e=this.options.views.active),l.show().buttonset().find(".ui-button").click(function(t){e=c(this).data("view"),i._viewChanged(e),t.preventDefault()}),(t=l.find('[for="'+i.id+"_view_"+e+'"]')).length&&t.trigger("click")):(l.show(),this._viewChanged(this.options.views.active)),this.options.views.thumbs&&this._displayThumbs()},_enableRenaming:function(){var o=this;this.filelist.dblclick(function(t){var i,e,l=c(t.target),s="";l.hasClass("plupload_file_name_wrapper")&&(t=(i=o.uploader.getFile(l.closest(".plupload_file")[0].id)).name,(e=/^(.+)(\.[^.]+)$/.exec(t))&&(t=e[1],s=e[2]),c('<input class="plupload_file_rename" type="text" />').width(l.width()).insertAfter(l.hide()).val(t).blur(function(){l.show().parent().scrollLeft(0).end().next().remove()}).keydown(function(t){var e=c(this);-1!==c.inArray(t.keyCode,[13,27])&&(t.preventDefault(),13===t.keyCode&&(i.name=e.val()+s,l.text(i.name)),e.blur())})[0].focus())})},_enableSortingList:function(){var l=this;c(".plupload_file",this.filelist).length<2||(c("tbody",this.filelist).sortable("destroy"),this.filelist.sortable({items:".plupload_delete",cancel:"object, .plupload_clearer",stop:function(){var i=[];c.each(c(this).sortable("toArray"),function(t,e){i[i.length]=l.uploader.getFile(e)}),i.unshift(i.length),i.unshift(0),Array.prototype.splice.apply(l.uploader.files,i)}}))}})}((window,document,plupload),jQuery);