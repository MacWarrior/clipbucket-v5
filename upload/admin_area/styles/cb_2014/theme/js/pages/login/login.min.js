const inputs=document.querySelectorAll("#mfa_code input");let modalElement=document.getElementById("enterMFACodeModal"),confirmButton=document.getElementById("confirmMFACodeBtn"),closeModalButton=document.querySelector(".close");function closeModal(){modalElement.classList.remove("in"),modalElement.style.display="none",modalElement.setAttribute("aria-hidden","true"),document.body.classList.remove("modal-open");let e=document.querySelector(".modal-backdrop");e&&e.remove()}function showModal(){modalElement.classList.add("in"),modalElement.style.display="block",modalElement.setAttribute("aria-hidden","false"),document.body.classList.add("modal-open");let e=document.createElement("div");e.className="modal-backdrop fade in",document.body.appendChild(e),modalElement.querySelectorAll('[data-dismiss="modal"]').forEach(function(e){e.addEventListener("click",closeModal)})}function insertHTMLAfter(e,t){let n=document.createRange();n.setStartAfter(e);let o=n.createContextualFragment(t);e.parentNode.insertBefore(o,e.nextSibling)}function insertHTMLBefore(e,t){let n=document.createRange();n.setStartBefore(e);let o=n.createContextualFragment(t);e.parentNode.insertBefore(o,e)}function showSpinner(){$(".taskHandler").show()}function hideSpinner(){$(".taskHandler").hide()}need_mfa=!1,document.addEventListener("DOMContentLoaded",function(){let e=document.querySelector('form[name="form1"]');e.addEventListener("submit",function(e){e.preventDefault(),showSpinner();let t=document.getElementById("username").value,n=document.getElementById("password").value;if(""===t||""===n)return alert(lang.please_fill_all_fields),hideSpinner(),!1;let o="";if("undefined"!=typeof need_mfa&&need_mfa){if(!1===modalElement.classList.contains("in"))return showModal(),!1;if(inputs.forEach(e=>{o+=e.value}),""===o.trim())return alert(lang.please_enter_mfa_code),hideSpinner(),!1;if(6!==o.length)return alert(lang.please_enter_6_digit_mfa_code),hideSpinner(),!1}fetch(admin_url+"actions/login.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({username:t,password:n,mfa_code:o})}).then(e=>e.json()).then(e=>{if(e.need_mfa?(showModal(),"email"===(need_mfa=e.need_mfa)&&(document.getElementById("email_mfa_hint").style.display="block"),hideSpinner()):e.success?(closeModalButton&&closeModalButton.click(),window.location.href=e.redirect):hideSpinner(),need_mfa){let t=document.querySelector("#enterMFACodeModal > div > div > div.modal-body > .form-group");t&&insertHTMLAfter(t,e.msg)}else{let n=document.querySelector("#login_box");n&&insertHTMLBefore(n,e.msg)}}).catch(e=>{console.error("Login error:",e),alert("An error occurred")})}),confirmButton&&confirmButton.addEventListener("click",function(){e.requestSubmit()}),closeModalButton&&closeModalButton.addEventListener("click",function(){closeModal()})}),inputs.forEach((e,t)=>{e.addEventListener("input",()=>{1===e.value.length&&t<inputs.length-1&&inputs[t+1].focus()}),e.addEventListener("keydown",n=>{"Backspace"===n.key&&""===e.value&&t>0&&inputs[t-1].focus()}),e.addEventListener("paste",e=>{e.preventDefault();let t=e.clipboardData.getData("text");for(let n=0;n<inputs.length;n++)inputs[n].value=t[n]||"";let o=Math.min(t.length,inputs.length)-1;o>=0&&inputs[o].focus()})});
