var eventSource,max_try=5;function setMaintenance(){return new Promise((t,a)=>{showSpinner(),$.ajax({url:admin_url+"actions/update_set_maintenance.php",type:"post",dataType:"json",success:function(e){hideSpinner(),0==e.success&&$(".page-content").prepend(e.msg),t(!0)},error:function(e){hideSpinner(),a(!1)}})})}function updateListeners(){$(".update_core").on("click",async function(){""!==message_php?await popinConfirm._confirm_it({message:message_php,title:lang.update})&&update("core"):""!==message_breaking_version?await popinConfirm._confirm_it({message:message_breaking_version,title:lang.update})&&(await popinConfirm._confirm_it({message:lang.maintenance_recommended,title:lang.update,text_button_confirm:lang.yes,text_button_cancel:lang.no})&&await setMaintenance(),update("core")):update("core")}),$(".update_db").on("click",function(){update("db")}),$(".launch_wip").on("click",async function(){await check_before_launch_update()&&(showSpinner(),$.ajax({url:admin_url+"actions/update_launch_wip.php",type:"post",dataType:"json",success:function(e){hideSpinner(),0==e.success&&$(".page-content").prepend(e.msg);var t=$(".launch_wip").parents(".alert"),a=t.parent();t.remove(),a.append(e.template),updateListeners()}}))}),$(".mark_as_failed").off("click").on("click",function(){var t=$(this).data("id");popinConfirm._confirm_it({message:lang.confirm_mark_as_failed,title:lang.update}).then(function(e){showSpinner(),$.ajax({url:admin_url+"actions/tool_force_to_error.php",type:"POST",data:{id_tool:t},dataType:"json"}).done(function(e){$(".page-content").prepend(e.msg)}).always(function(){updateInfo(0),hideSpinner()})})})}$(document).ready(function(){var n=admin_url+"index.php";function i(t){$.post(n,{mode:"delete_note",id:t},function(e){$("#note-"+t).slideUp()},"text")}$(".oneNote .delete").on({click:function(e){e.preventDefault(),i($(this).parent().attr("id")),$(this).parents("li").remove()}}),$("#add_new_note").on({click:function(e){e.preventDefault();let o=$(this).parents(".addNote").find("textarea").val();o?($(this).parents(".addNote").find("textarea").val(""),$.post(n,{mode:"add_note",note:o},function(e){var t=document.createElement("li"),a=(t.className="col-md-4",document.createElement("a")),n=(a.className="delete",a.href="#",a.innerHTML="x",document.createElement("p"));n.id=e.id,n.innerHTML=$("<textarea/>").text(o).html(),n.className="oneNote",$(n).append(a),$(t).append(n),$(a).on({click:function(e){e.preventDefault(),i($(this).parent().attr("id")),$(this).parents("li").remove()}}),$(".notesList").prepend(t)},"json")):alert("Please enter something")}}),$("#addTodo").on({click:function(e){e.preventDefault();e=$(this).parents(".addTodo").find("input").val();e.length?($(this).parents(".addTodo").find("input").val(""),$.ajax({url:n,type:"post",data:{val:e,mode:"add_todo"},success:function(e){e=$.parseJSON(e);var t=document.createElement("li"),a=(t.className="col-md-12 oneTodo",document.createElement("span")),e=(a.className="paddingLeftSmall col-md-10",a.id=e.id,a.innerHTML=e.todo,document.createElement("a"));e.href="#",e.className="btn btn-danger btn-xs delete col-md-2",e.innerHTML=lang_delete,$(e).on("click",function(e){e.preventDefault();var t=this,e=$(this).prev().attr("id");$.ajax({url:n,type:"post",data:{id:e,mode:"delete_todo"},success:function(e){$(t).parents("li").remove()}})}),$(t).append(a).append(e),$(".todosList").prepend(t)}})):alert("Please enter a valid value")}}),$("#todolist .delete").on("click",function(e){e.preventDefault();const t=$(this);$.ajax({url:n,type:"post",data:{id:$(this).prev().attr("id"),mode:"delete_todo"},success:function(e){t.parents("li").remove()}})}),$("#todolist").on("click",".editable-clear-x",function(e){e.preventDefault();let t=$(this).parents(".editable-container").prev().attr("id");t=(t=t.match(/([0-9]+)$/g)).pop(),$.ajax({url:n,type:"post",data:{id:t,mode:"delete_todo"},success:function(e){$(this).parents("p").remove(),$(this).parents(".editable-container").remove()}}),e.stopPropagation()}),"true"===can_sse&&is_update_processing,"true"===is_update_processing&&refreshUpdateProgression(),updateListeners(),visual_editor_comments_enabled&&Array.from(document.querySelectorAll("#rcomments .itemdiv .text")).forEach((e,t)=>{new toastui.Editor.factory({el:e,viewer:!0,usageStatistics:!1,initialValue:e.innerHTML})}),AmCharts.makeChart("piechart",{type:"pie",adjustPrecision:!0,angle:12,balloonText:"[[title]]<br><span style='font-size:14px;'><b>[[value]]</b> ([[percents]]%)</span>",depth3D:15,maxLabelWidth:150,titleField:"category",valueField:"column-1",processTimeout:5,theme:"light",allLabels:[],balloon:{},legend:{enabled:!0,align:"left",markerType:"circle"},titles:[{bold:!1,id:"Title-1",size:15,text:lang.overall_statistics}],dataProvider:[{category:lang.users,"column-1":piechart_users},{category:lang.photos,"column-1":piechart_photos},{category:lang.videos,"column-1":piechart_videos},{category:lang.collections,"column-1":piechart_collections}]}),AmCharts.makeChart("donutchart",{type:"pie",angle:12,balloonText:"[[title]]<br><span style='font-size:14px;'><b>[[value]]</b> ([[percents]]%)</span>",depth3D:15,innerRadius:"30%",titleField:"category",valueField:"column-1",processTimeout:5,theme:"light",allLabels:[],balloon:{},legend:{enabled:!0,align:"center",markerType:"circle"},titles:[{bold:!1,id:"Title-1",size:15,text:lang.flagged_obj}],dataProvider:[{category:lang.photos,"column-1":donutchart_photos},{category:lang.videos,"column-1":donutchart_videos},{category:lang.users,"column-1":donutchart_users},{category:lang.collections,"column-1":donutchart_collections}]}),AmCharts.makeChart("ubarchart",{type:"serial",pathToImages:"https://www.amcharts.com/lib/3/images/",categoryField:"category",startDuration:1,mouseWheelZoomEnabled:!0,startEffect:"easeOutSine",autoDisplay:!0,theme:"light",categoryAxis:{gridPosition:"start"},trendLines:[],graphs:[{colorField:"color",fillAlphas:1,id:"AmGraph-1",lineColorField:"color",title:"graph 1",type:"column",valueField:"column-1"}],guides:[],valueAxes:[{id:"ValueAxis-1",title:lang.users}],allLabels:[],balloon:{},titles:[{bold:!1,id:"Title-1",size:15,text:lang.user_statistics}],dataProvider:[{category:lang.total,"column-1":ubarchart_users},{category:lang.active,"column-1":ubarchart_users_active},{category:lang.inactive,"column-1":ubarchart_users_inactive}]}),AmCharts.makeChart("vbarchart",{type:"serial",pathToImages:"https://www.amcharts.com/lib/3/images/",categoryField:"category",startDuration:1,mouseWheelZoomEnabled:!0,startEffect:"easeOutSine",autoDisplay:!0,theme:"light",categoryAxis:{gridPosition:"start"},trendLines:[],graphs:[{colorField:"color",fillAlphas:1,id:"AmGraph-1",lineColorField:"color",title:"graph 1",type:"column",valueField:"column-1"}],guides:[],valueAxes:[{id:"ValueAxis-1",title:lang.videos}],allLabels:[],balloon:{},titles:[{bold:!1,id:"Title-1",size:15,text:lang.video_statistics}],dataProvider:[{category:lang.total,"column-1":vbarchart_total},{category:lang.active,"column-1":vbarchart_active},{category:lang.inactive,"column-1":vbarchart_deactive},{category:lang.reported,"column-1":vbarchart_reported}]}),$("#update_dp_options").on("click",function(){var e=$(this).parent().find("input").val();$.ajax({url:admin_url+"actions/display_option_update.php",type:"post",dataType:"json",data:{admin_pages:e},success:function(e){$(".page-content").prepend(e.msg)}})})});let showMsg=function(e,t,a){let n="ajax_msg_"+(Math.random()+1).toString(36).substring(7);$("#update_div").append('<div role="alert" id="'+n+'" class="alert alert-'+t+' alert-dismissible">    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">Ã—</span></button>    <div class="msg">'+e+"</div></div>"),!0===a&&setTimeout(function(){$("#"+n).addClass("hidden")},5e3)};async function update(a){$(".launch_wip").off("click").prop("disabled","disabled"),$(".update_db").off("click").prop("disabled","disabled"),$(".update_core").off("click").prop("disabled","disabled"),await check_before_launch_update()&&$.ajax({url:admin_url+"actions/update_launch.php",type:"post",data:{type:a},success:function(e){let t;try{t=JSON.parse(e)}catch(e){t.success=!1}if(!0!==t.success){let e=lang.technical_error;void 0!==t.error_msg&&null!=t.error_msg&&""!=t.error_msg&&(e=t.error_msg),void showMsg(e,"danger")}else $("#update_div").html(t.html),refreshUpdateProgression(a)}})}async function check_before_launch_update(){var e=await $.ajax({url:admin_url+"actions/update_check_before_launch.php",type:"post",dataType:"json",processData:!1,data:{core_checked:!1,db_checked:!1,conversion_checked:!1}});if(!e.core_checked&&"string"==typeof e.confirm_message_core&&""!==e.confirm_message_core){if(!confirm(e.confirm_message_core))return!1;await $.ajax({url:admin_url+"actions/tool_force_to_error.php",type:"POST",data:{id_tool:e.id_tool},dataType:"json",success:function(e){}})}if(!e.db_checked&&"string"==typeof e.confirm_message_db&&""!==e.confirm_message_db){if(!confirm(e.confirm_message_db))return!1;await $.ajax({url:admin_url+"actions/tool_force_to_error.php",type:"POST",data:{id_tool:e.id_tool},dataType:"json",success:function(e){console.log("ajax success")}})}return!(!e.conversion_checked&&"string"==typeof e.confirm_message_conv&&""!==e.confirm_message_conv&&!confirm(e.confirm_message_conv))}function refreshUpdateProgression(e){var t=setInterval(function(){updateInfo(t,e)},5e3)}function updateInfo(a,e){$.ajax({url:admin_url+"actions/update_info.php",type:"post",data:{type:e},dataType:"json",success:function(e){var t;$("#update_div").html(e.html),updateListeners(),hideSpinner(),e.msg_template&&$(".page-content").prepend(e.msg_template),0!=e.modal_error&&((t=$("#myModal")).find("#error_update").html(e.modal_error),t.modal()),"false"===e.is_updating?(clearInterval(a),checkStatus()):(t=e.update_info,$(".launch_wip").off("click"),t&&0<t.elements_done&&$("#progress_div").show(),$("#progress-bar").attr("aria-valuenow",t.pourcent).width(t.pourcent+"%"),$("#pourcent").html(t.pourcent),$("#done").html(t.elements_done),$("#total").html(t.elements_total))}})}function checkStatus(){$.ajax({url:admin_url+"actions/update_check.php",type:"post",dataType:"json",success:function(e){$("#changelog_display").html(e.changeLog),$("#status_html").html(e.html),e.msg&&$(".page-content").prepend(e.msg),$(".footer").find("em>a").html("V"+e.version+" - "+e.revision)}})}