var eventSource,eventSourceLog,max_try=5,ids_stopped=[];function connectSSE(){var t=0;(eventSource=new EventSource("/admin_area/sse/progress_tool.php")).addEventListener("message",function(e){var e=JSON.parse(e.data),o=[];e.forEach(function(e){$("#progress-bar-"+e.id).attr("aria-valuenow",e.pourcent).width(e.pourcent+"%"),$("#pourcent-"+e.id).html(e.pourcent),$("#done-"+e.id).html(e.elements_done),$("#total-"+e.id).html(e.elements_total),o.push(e.id)}),$(".progress-bar:visible").each(function(e,t){let a=(t=$(t)).attr("data-id");if(!o.includes(a)){if(ids_stopped.includes(parseInt(a))){t.addClass("progress-bar-striped ").addClass("active");const e=ids_stopped.indexOf(parseInt(a));ids_stopped.splice(e,1)}else t.addClass("progress-bar-success"),t.width("100%"),$(".launch[data-id="+a+"]").parent().removeClass("disabled"),$(".stop[data-id="+a+"]").parent().addClass("disabled"),$("#span-"+a).html(lang.completed),$("#progress-bar-"+a).attr("aria-valuenow",100).width("100%"),$("#done-"+a).html($("#total-"+a).html()),$("#pourcent-"+a).html(100);setTimeout(function(){$("#progress-"+a).hide(),$("#span-"+a).html(lang.ready),$("#progress-bar-"+a).removeClass("progress-bar-success").attr("aria-valuenow",0).width("0%"),$("#pourcent-"+a).html(0),$("#done-"+a).html(0),$("#total-"+a).html(0)},1e4)}})},!1),eventSource.addEventListener("open",function(e){max_try<++t&&eventSource.close()},!1),eventSource.addEventListener("error",function(e){eventSource.close()},!1)}function connectSSELog(e,t){var a=0;(eventSourceLog=new EventSource("/admin_area/sse/logs_tool.php?max_id="+e+"&id_tool="+t)).addEventListener("message",function(e){JSON.parse(e.data).forEach(function(e){$("#tool_logs").append("<tr><td>"+e.datetime+"</td><td>"+e.message+"</td></tr>")})},!1),eventSourceLog.addEventListener("open",function(e){max_try<++a&&eventSourceLog.close()},!1),eventSourceLog.addEventListener("error",function(e){eventSourceLog.close()},!1)}$(function(){console.log(can_sse),"true"==can_sse&&connectSSE(),$(".launch").on("click",function(){var t,a=$(this);a.parent().hasClass("disabled")||(t=$(this).data("id"),$.ajax({url:"/actions/launch_tool.php",type:"POST",data:{id_tool:t},dataType:"json",success:function(e){$("#progress-bar-"+t).removeClass("progress-bar-success").attr("aria-valuenow",0).width("0%"),$("#span-"+t).html(e.libelle_status),$("#pourcent-"+t).html(0),$("#done-"+t).html(0),$("#total-"+t).html(0),$(".page-content").prepend(e.msg),a.parent().addClass("disabled"),$('.stop[data-id="'+t+'"]').parent().removeClass("disabled"),$("#progress-"+t).show()}}))}),$(".stop").on("click",function(){var t,a=$(this);$(this).parent().hasClass("disabled")||(t=a.data("id"),$.ajax({url:"/actions/stop_tool.php",type:"POST",data:{id_tool:t},dataType:"json",success:function(e){$("#span-"+t).html(e.libelle_status),a.parent().addClass("disabled"),$(".page-content").prepend(e.msg),ids_stopped.push(t)}}))}),$(".show_log").on("click",function(){var e=$(this);$(this).parent().hasClass("disabled")||(e=e.data("id"),$.ajax({url:"/actions/show_tool_log.php",type:"POST",data:{id_tool:e},dataType:"json",success:function(e){connectSSELog(e.max_id_log,e.id_tool),$(".page-content").prepend(e.msg),$("#logModal").find(".modal-body").html(e.template),$("#logModal").modal()}}))}),$("#logModal").on("hidden.bs.modal",function(){eventSourceLog.close()})});