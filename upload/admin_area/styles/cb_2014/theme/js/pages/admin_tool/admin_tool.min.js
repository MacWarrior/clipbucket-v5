var eventSource,eventSourceLog,max_try=5,ids_stopped=[],ids_error=[];function connectSSE(){var t=0;(eventSource=new EventSource("/admin_area/sse/progress_tool.php")).addEventListener("message",function(e){var e=JSON.parse(e.data),a=[];e.forEach(function(e){$("#progress-bar-"+e.id).attr("aria-valuenow",e.pourcent).width(e.pourcent+"%"),$("#pourcent-"+e.id).html(e.pourcent),$("#done-"+e.id).html(e.elements_done),$("#total-"+e.id).html(e.elements_total),a.push(parseInt(e.id)),"on_error"==e.status&&($("#span-"+e.id).html(e.status_title),!1===ids_error.includes(parseInt(e.id)))&&ids_error.push(parseInt(e.id))}),$(".progress-bar:visible").each(function(e,t){let s=(t=$(t)).attr("data-id");if(console.log(a),a.includes(parseInt(s)))ids_error.includes(parseInt(s))&&(t.removeClass("progress-bar-success").addClass("progress-bar-danger").addClass("progress-bar-striped").attr("aria-valuenow",100).width("100%"),$(".launch[data-id="+s+"]").parent().removeClass("disabled"),$(".stop[data-id="+s+"]").parent().addClass("disabled"));else{if(ids_stopped.includes(parseInt(s))){t.addClass("progress-bar-striped").addClass("active");const e=ids_stopped.indexOf(parseInt(s));ids_stopped.splice(e,1)}else t.addClass("progress-bar-success"),t.width("100%"),$(".launch[data-id="+s+"]").parent().removeClass("disabled"),$(".stop[data-id="+s+"]").parent().addClass("disabled"),$("#span-"+s).html(lang.completed),$("#progress-bar-"+s).attr("aria-valuenow",100).width("100%"),$("#done-"+s).html($("#total-"+s).html()),$("#pourcent-"+s).html(100);setTimeout(function(){$("#progress-"+s).hide(),$("#span-"+s).html(lang.ready),$("#progress-bar-"+s).removeClass("progress-bar-success").attr("aria-valuenow",0).width("0%"),$("#pourcent-"+s).html(0),$("#done-"+s).html(0),$("#total-"+s).html(0)},1e4)}})},!1),eventSource.addEventListener("open",function(e){max_try<++t&&eventSource.close()},!1),eventSource.addEventListener("error",function(e){eventSource.close()},!1)}function connectSSELog(e,t){var s=0;(eventSourceLog=new EventSource("/admin_area/sse/logs_tool.php?max_id="+e+"&id_tool="+t)).addEventListener("message",function(e){JSON.parse(e.data).forEach(function(e){$("#tool_logs").append("<tr><td>"+e.datetime+"</td><td>"+e.message+"</td></tr>")})},!1),eventSourceLog.addEventListener("open",function(e){max_try<++s&&eventSourceLog.close()},!1),eventSourceLog.addEventListener("error",function(e){eventSourceLog.close()},!1)}$(function(){"true"==can_sse&&connectSSE(),$(".launch").on("click",function(){var t,s=$(this);s.parent().hasClass("disabled")||(t=$(this).data("id"),$.ajax({url:"/actions/launch_tool.php",type:"POST",data:{id_tool:t},dataType:"json",success:function(e){$("#progress-bar-"+t).removeClass("progress-bar-success").attr("aria-valuenow",0).width("0%"),$("#span-"+t).html(e.libelle_status),$("#pourcent-"+t).html(0),$("#done-"+t).html(0),$("#total-"+t).html(0),$(".page-content").prepend(e.msg),s.parent().addClass("disabled"),$('.stop[data-id="'+t+'"]').parent().removeClass("disabled"),$("#progress-"+t).show()}}))}),$(".stop").on("click",function(){var t,s=$(this);$(this).parent().hasClass("disabled")||(t=s.data("id"),$.ajax({url:"/actions/stop_tool.php",type:"POST",data:{id_tool:t},dataType:"json",success:function(e){$("#span-"+t).html(e.libelle_status),s.parent().addClass("disabled"),$(".page-content").prepend(e.msg),ids_stopped.push(t)}}))}),$(".show_log").on("click",function(){var e=$(this);$(this).parent().hasClass("disabled")||(e=e.data("id"),$.ajax({url:"/actions/show_tool_log.php",type:"POST",data:{id_tool:e},dataType:"json",success:function(e){connectSSELog(e.max_id_log,e.id_tool),$(".page-content").prepend(e.msg),$("#logModal").find(".modal-body").html(e.template),$("#logModal").modal()}}))}),$("#logModal").on("hidden.bs.modal",function(){eventSourceLog.close()})});